name: blockbuilders-dev

services:
  backend:
    build:
      context: ../..
      dockerfile: configs/docker/backend.Dockerfile
    env_file:
      - ../../apps/backend/.env
    environment:
      # Point backend at the Timescale/Postgres container instead of localhost inside Compose
      DATABASE_URL: postgresql://postgres:postgres@timescaledb:5432/postgres
    command:
      - uv
      - run
      - --directory
      - apps/backend
      - fastapi
      - dev
      - app/main.py
      - --host
      - 0.0.0.0
      - --port
      - "8000"
    working_dir: /workspace
    volumes:
      - ../../:/workspace
      - backend_uv_cache:/root/.cache/uv
    ports:
      - "8000:8000"
    healthcheck:
      test:
        - CMD
        - curl
        - -f
        - http://localhost:8000/health
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - app-network

  timescaledb:
    image: timescale/timescaledb:latest-pg16
    container_name: timescaledb
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: postgres
    ports:
      - "54322:5432"
    volumes:
      - timescaledb_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - app-network

  frontend:
    build:
      context: ../..
      dockerfile: configs/docker/frontend.Dockerfile
    env_file:
      - ../../apps/frontend/.env.local
    environment:
      # Point the Next.js client at the FastAPI service running in this Compose network
      STATUS_API_BASE_URL: http://backend:8000
      ONBOARDING_API_URL: http://backend:8000
    command:
      - pnpm
      - --filter
      - ./apps/frontend...
      - dev
      - --hostname
      - 0.0.0.0
    working_dir: /workspace
    depends_on:
      backend:
        condition: service_healthy
    volumes:
      - ../../:/workspace
      - frontend_pnpm_store:/root/.local/share/pnpm/store
    ports:
      - "3000:3000"
    healthcheck:
      test:
        - CMD
        - curl
        - -f
        - http://localhost:3000
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 15s
    networks:
      - app-network

volumes:
  backend_uv_cache:
  frontend_pnpm_store:
  timescaledb_data:

networks:
  app-network:
    driver: bridge
